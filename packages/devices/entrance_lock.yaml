#
# Entrance Lock
#

input_text:
  auto_lock_uuid:
    initial: !secret auto_lock_uuid
  door_lock_uuid:
    initial: !secret door_lock_uuid

#
# Entrance Lock statuses
#
sensor:
  - platform: rest
    name: Entrance Door Lock Sensor
    scan_interval: 600
    method: GET
    headers:
      x-api-key: !secret sesame_api_key
    resource_template: "https://app.candyhouse.co/api/sesame2/{{ states('input_text.door_lock_uuid') }}"
    value_template: '{{ value_json.CHSesame2Status }}'
    json_attributes:
      - batteryPercentage
      - batteryVoltage
      - position
      - CHSesame2Status
      - timestamp

  - platform: rest
    name: Entrance Auto Lock Sensor
    scan_interval: 600
    method: GET
    headers:
      x-api-key: !secret sesame_api_key
    resource_template: "https://app.candyhouse.co/api/sesame2/{{ states('input_text.auto_lock_uuid') }}"
    value_template: '{{ value_json.CHSesame2Status }}'
    json_attributes:
      - batteryPercentage
      - batteryVoltage
      - position
      - CHSesame2Status
      - timestamp

#
# Entrance Lock commands
#
shell_command:
  sesame: "/config/python_scripts/sesame.py {{ command }} {{ api_key }} {{ uuid }} {{ secret }}"

script:
  toggle_entrance_auto_lock:
    alias: Toggle Entrance Auto Lock
    sequence:
      - service: shell_command.sesame
        data_template:
          command: lock
          api_key: !secret sesame_api_key
          uuid: !secret auto_lock_uuid
          secret: !secret auto_lock_secret
      - delay:
          seconds: 1
      # trigger "lock" command twice to ensure button is pressed
      - service: shell_command.sesame
        data_template:
          command: lock
          api_key: !secret sesame_api_key
          uuid: !secret auto_lock_uuid
          secret: !secret auto_lock_secret
      - delay:
          seconds: 2
      # trigger "unlock" command to release button press
      - service: shell_command.sesame
        data_template:
          command: unlock
          api_key: !secret sesame_api_key
          uuid: !secret auto_lock_uuid
          secret: !secret auto_lock_secret
      - delay:
          seconds: 5
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.entrance_auto_lock_sensor

  lock_entrance_door:
    sequence:
      - service: shell_command.sesame
        data_template:
          command: lock
          api_key: !secret sesame_api_key
          uuid: !secret door_lock_uuid
          secret: !secret door_lock_secret
      - delay:
          seconds: 3
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.entrance_door_lock_sensor

  unlock_entrance_door:
    sequence:
      - service: shell_command.sesame
        data_template:
          command: unlock
          api_key: !secret sesame_api_key
          uuid: !secret door_lock_uuid
          secret: !secret door_lock_secret
      - delay:
          seconds: 3
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.entrance_door_lock_sensor

  open_sesame:
    alias: Open Sesame
    sequence:
      - service: script.toggle_entrance_auto_lock
      - delay:
          seconds: 20
      - service: script.unlock_entrance_door
      - delay:
          seconds: 125
      - service: script.lock_entrance_door

#
# Entrance Lock entity
#
lock:
  - platform: template
    name: Entrance Door
    value_template: "{{ is_state('sensor.entrance_door_lock_sensor', 'locked') }}"
    lock:
      service: script.lock_entrance_door
    unlock:
      service: script.unlock_entrance_door
